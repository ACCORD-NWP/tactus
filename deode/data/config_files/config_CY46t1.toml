[general]
 case = "@CYCLE@_@CSC@_MARS3"
 cnmexp = "DEOD"
 realization = -1
 tstep = 50
 loglevel = "debug"
 csc = "AROME"
 cycle = "CY46t1"
 surfex = true
 marsprep_global = true 
 forecast_range = "PT6H"
 keep_workdirs = true
 accept_static_namelists = false
 nproma = -32
 mars_expver= "0001"

[boundaries]
 bdstrategy = "same_forecast"
 bdint = "PT1H"
 bdshift = "PT0H"
 bdcycle = "PT12H"
 bdmodel = "ifs"
 bd_has_surfex = false
 bdmax = 12

[general.output_settings]
 history = ["PT1H:PT12H:PT1H"]
 fullpos = ["PT6H:PT15M", "PT9H:PT30M", "PT1H"]
 surfex = ["PT3H:PT1H", "PT9H:PT24H:PT3H"]

[suite_control]
 create_static_data = true
 create_time_dependent_suite = true
 do_soil = false
 do_pgd = true
 do_prep = true
 interpolate_boundaries = true
 do_marsprep = true

[file_templates]
 duration_grib = "@LLLH@h@LM@m@LS@s"
 duration_fa = "@LLLH@:@LM@:@LS@"
 history = "ICMSH@CNMEXP@+@DURATION_FA@"
 surfex = "ICMSH@CNMEXP@+@DURATION_FA@.sfx"
 fullpos = "GRIBPF@CNMEXP@@DOMAIN@+@DURATION_FA@"

[macros]
 os_macros = ["USER", "HOME", "PWD"]
 group_macros = ["platform","system"]
 gen_macros = ["general.cnmexp",
               "general.mars_expver",
               "general.cycle",
               "general.csc",
               "file_templates.duration_grib",
               "file_templates.duration_fa",
               { surfex_template = "file_templates.surfex" },
               { case = "general.case" },
               { domain = "domain.name" },
               { rrr = "general.realization" } ]

[vertical_levels]
 nlev = 90 
 ahalf=[0.0,
    2718.281829,
    3747.089291,
    5034.628437,
    6544.912331,
    8198.254772,
    9884.037509,
    11495.975326,
    13027.505452,
    14563.582313,
    16027.001094,
    17350.572570,
    18488.484485,
    19421.729531,
    20150.678519,
    20703.501353,
    21120.067860,
    21422.374439,
    21617.205213,
    21700.607608,
    21664.253163,
    21503.836344,
    21228.956759,
    20852.005941,
    20386.366609,
    19845.368084,
    19241.349855,
    18584.887324,
    17884.206486,
    17144.791188,
    16369.171264,
    15556.874071,
    14719.777823,
    13869.911343,
    13018.864414,
    12177.273612,
    11354.413453,
    10557.908483,
    9793.568381,
    9065.336892,
    8375.337452,
    7723.994524,
    7110.208402,
    6531.565033,
    5988.625732,
    5481.396429,
    5009.397153,
    4571.733424,
    4167.166971,
    3794.183751,
    3451.057718,
    3135.909257,
    2846.757685,
    2581.567536,
    2338.288920,
    2114.891972,
    1909.396606,
    1719.898028,
    1545.164089,
    1384.095523,
    1235.715886,
    1099.160647,
    973.665696,
    858.555496,
    753.231040,
    657.157769,
    569.853600,
    490.877204,
    419.816710,
    356.279006,
    299.879869,
    250.235155,
    206.953392,
    169.629978,
    137.661377,
    110.481694,
    87.562438,
    68.412047,
    52.575220,
    39.632072,
    29.197140,
    20.918270,
    14.475386,
    9.579184,
    5.969747,
    3.415109,
    1.709778,
    0.673225,
    0.148360,
    0.000000,
    0.000000]
 bhalf=[0.0,
    0.0000000000,
    0.0000000000,
    0.0000000000,
    0.0000000000,
    0.0000000000,
    0.0002553339,
    0.0012582626,
    0.0032186754,
    0.0065542091,
    0.0115260859,
    0.0182233571,
    0.0265306802,
    0.0361650379,
    0.0466837499,
    0.0578169615,
    0.0697514905,
    0.0827965908,
    0.0972973540,
    0.1135392122,
    0.1316354653,
    0.1513917778,
    0.1721529871,
    0.1937287238,
    0.2159368732,
    0.2386170760,
    0.2616429112,
    0.2849322192,
    0.3084553280,
    0.3322412065,
    0.3563817662,
    0.3810346250,
    0.4059735997,
    0.4309763608,
    0.4558322276,
    0.4803492980,
    0.5043605563,
    0.5277287467,
    0.5503499447,
    0.5721558758,
    0.5931151226,
    0.6132334074,
    0.6325531814,
    0.6511527023,
    0.6690096121,
    0.6861106095,
    0.7024509531,
    0.7180339228,
    0.7328702640,
    0.7469776359,
    0.7603800785,
    0.7731075119,
    0.7851952736,
    0.7966837018,
    0.8076177578,
    0.8180467044,
    0.8280238137,
    0.8376061181,
    0.8468231941,
    0.8557014234,
    0.8642639577,
    0.8725307031,
    0.8805183181,
    0.8882402246,
    0.8957066275,
    0.9029245414,
    0.9098978232,
    0.9166272078,
    0.9231103463,
    0.9293418440,
    0.9353132984,
    0.9410133344,
    0.9464276294,
    0.9515389442,
    0.9563559969,
    0.9608873801,
    0.9651415535,
    0.9691268385,
    0.9728514153,
    0.9763233211,
    0.9795504499,
    0.9825405544,
    0.9853012477,
    0.9878400070,
    0.9901641777,
    0.9922809780,
    0.9941975046,
    0.9959207382,
    0.9974575502,
    0.9988147073,
    1.0000000000]

[domain]
 name = "DEMO_60x80_2500m"
 nimax = 49
 njmax = 69
 xloncen = 4.9
 xlatcen = 51.967
 xlon0 = 0.0
 xlat0 = 52.5
 xbeta  = 0.0
 xdx = 2500.0
 xdy = 2500.0
 ilone = 11
 ilate = 11
 nbzong = 8
 nbzonl = 8
 gridtype = "linear"

[system]
 wrk = "@SCRATCH@/deode/@CASE@/@YYYY@@MM@@DD@_@HH@@mm@"
 archive = "@ARCHIVE_ROOT@/@YYYY@/@MM@/@DD@/@HH@/"
 bddir = "@INTP_BDDIR@"
 intp_bddir = "@WRK@"
 bdfile_template = "ELSCF@CNMEXP@ALBC@NNN@"
 marsfile_template = "mars_prefetch_[levtype]_[date]_[time]+[step]"
 bddir_sfx = "@MARSDIR@"
 bdfile_sfx_template = "fc@YYYY@@MM@@DD@_@HH@+@LLL@"
 climdir = "@SCRATCH@/deode/@CASE@/climate/@DOMAIN@"
 bdclimdir = "/home/snh02/work/dev-CY46h1_deode/climate/DEODE_LARGE"
 bindir = "/home/snh02/work/cy46t1/arome/bin/2023-05-19"
 fullpos_config_file = "@DEODE_HOME@/deode/namelist_generation_input/@CYCLE@/fullpos_namelist.yml"
 sfx_input_defs = "@DEODE_HOME@/deode/data/input/sfx_input_@CYCLE@.json"
 namelists = "@DEODE_HOME@/deode/data/namelists/@CYCLE@"
 marsdir = "/scratch/@USER@/deode/@CASE@/ECMWF_DATA/@YYYY@/@MM@/@DD@/@HH@/@MARS_EXPVER@"
 global_sfcdir = "/hpcperm/snh02/climate_fields_mir/climate.v020_MIR_orog/"

[platform]
deode_home = "set-by-the-system"
scratch = "/scratch/@USER@"
archive_root = "@SCRATCH@/deode/@CASE@/archive"
static_data = "/hpcperm/snh02/DEODE"
climdata = "@STATIC_DATA@/climate"
rrtm_dir = "@STATIC_DATA@/rrtm/@CYCLE@"
ncdir = "@STATIC_DATA@/ncdir"
e923_data = "@STATIC_DATA@/climate/E923_DATA"
ecosg_data_path = "@CLIMDATA@/ECOCLIMAP-SG"
ecoclim_data_path = "@CLIMDATA@/ecoclimap"
gmted2010_data_path = "@CLIMDATA@/GMTED2010"
soilgrid_data_path = "@CLIMDATA@/SOILGRID"
pgd_data_path = "@CLIMDATA@/PGD"
task_name = "@STAND_ALONE_TASK_NAME@"
ecoclimap_bin_dir = "@ecoclim_data_path@"


[general.times]
 basetime = "2023-08-03T12:00:00Z"
 validtime = "2023-08-03T12:00:00Z"
 start = "2023-08-03T12:00:00Z"
 end = "2023-08-05T12:00:00Z"
 cycle_length = "PT1H"
 
[task]
 wrapper = ""

[task.args]
 bd_nr = "0"
 bd_time = "2023-08-03T12:00:00Z"

[task.creategrib]
 bindir = "/home/snh02/gl/ECMWF.atos.gnu/bin"

[task.PgdUpdate]
 bindir = "/home/snh02/gl/ECMWF.atos.gnu/bin"

[task.creategrib.conversions.surfex]
 input_template = "@SURFEX_TEMPLATE@"
 output_template = "sfx_@YYYY@-@MM@-@DD@T@HH@:@mm@:@ss@+@DURATION_GRIB@.grib" 

[submission]
submit_types = ["background_vm", "background_hpc", "serial", "parallel"]
default_submit_type = "serial"

[submission.background_vm]
INTERPRETER = "#!/usr/bin/python3"
SCHOST = "localhost"
tasks = ["Background_vm"]

[submission.background_hpc]
SCHOST = "localhost"
tasks = ["creategrib", "Background_hpc", "UnitTest"]

[submission.serial]
 SCHOST = "hpc"
 NPROC = 1
 NPROCX = 1
 NPROCY = 1
 WRAPPER = "srun"
 tasks = ["Gmted", "Soil", "Marsprep"]

[submission.serial.BATCH]
 NAME = "#SBATCH --job-name=@TASK_NAME@"
 ACCOUNT = "#SBATCH -A msdeode"
 WALLTIME = "#SBATCH --time=00:15:00"
 QOS = "#SBATCH --qos=nf"
 NODES = "#SBATCH --nodes=1"
 NTASKS= "#SBATCH --ntasks=1"

[submission.serial.ENV]
 OS = "import os"
 MODULE_ENV= "exec(open('/usr/local/apps/lmod/8.6.8/init/env_modules_python.py').read())"
 MODULE_INTEL= "module('load', 'prgenv/intel')"
 MODULE_MKL= "module('load', 'intel-mkl/19.0.5')"
 MODULE_OPENMPI= "module('load', 'hpcx-openmpi/2.9.0')"
 MODULE_NETCDF4= "module('load', 'netcdf4/4.7.4')"
 MODULE_HDF5= "module('load', 'hdf5/1.10.6')"
 MODULE_ECMWF= "module('load', 'ecmwf-toolbox/2023.04.1.0')"
 MODULE_FFTW= "module('load', 'fftw/3.3.9')"
 OMP_NUM_THREADS= "os.environ['OMP_NUM_THREADS'] = '1'"
 OMPI_MCA_btl= "os.environ['OMPI_MCA_btl'] = '^vader'"
 DR_HOOK_SIGNALS = "os.environ['DR_HOOK_IGNORE_SIGNALS'] = '-1'"

[submission.task_exceptions.Gmted.ENV]
 MODULE_GDAL= "module('load', 'gdal/3.2.1')"

[submission.task_exceptions.Soil.ENV]
 MODULE_GDAL= "module('load', 'gdal/3.2.1')"

[submission.parallel]
 SCHOST = "hpc"
 tasks = ["Forecast", "e927", "Pgd", "Prep", "c903"]
 NPROC = 32
 WRAPPER = "srun"
[submission.parallel.BATCH]
 NAME = "#SBATCH --job-name=@TASK_NAME@"
 ACCOUNT = "#SBATCH -A msdeode"
 WALLTIME = "#SBATCH --time=00:10:00"
 QOS = "#SBATCH --qos=np"

[submission.parallel.ENV]
 OS = "import os"
 MODULE_ENV= "exec(open('/usr/local/apps/lmod/8.6.8/init/env_modules_python.py').read())"
 MODULE_INTEL= "module('load', 'prgenv/intel')"
 MODULE_MKL= "module('load', 'intel-mkl/19.0.5')"
 MODULE_OPENMPI= "module('load', 'hpcx-openmpi/2.9.0')"
 MODULE_NETCDF4= "module('load', 'netcdf4/4.7.4')"
 MODULE_HDF5= "module('load', 'hdf5/1.10.6')"
 MODULE_ECMWF= "module('load', 'ecmwf-toolbox/2023.04.1.0')"
 MODULE_FFTW= "module('load', 'fftw/3.3.9')"
 OMP_NUM_THREADS= "os.environ['OMP_NUM_THREADS'] = '1'"
 DR_HOOK = "os.environ['DR_HOOK'] = '1'"
 DR_HOOK_SIGNALS = "os.environ['DR_HOOK_IGNORE_SIGNALS'] = '-1'"
 OMPI_MCA_btl= "os.environ['OMPI_MCA_btl'] = '^vader'"

[submission.task_exceptions.e927]
 NPROC = 16

[submission.task_exceptions.e927.BATCH]
 NODES = "#SBATCH --nodes=1"
 NTASKS = "#SBATCH --ntasks=16"

[submission.task_exceptions.c903]
 NPROC = 36
[submission.task_exceptions.c903.BATCH]
 NODE = "#SBATCH --nodes=12"
 NTASKS = "#SBATCH --ntasks=36"
 MEM = "#SBATCH --mem=200GB" 
 WALLTIME = "#SBATCH --time=00:30:00" 

[submission.task_exceptions.Forecast]
 NPROC = 256
 
[submission.task_exceptions.Forecast.BATCH]
 NODES = "#SBATCH --nodes=2"
 NTASKS = "#SBATCH --ntasks=256"
 WALLTIME = "#SBATCH --time=00:30:00"

[submission.task_exceptions.Pgd.BATCH]
 NODES = "#SBATCH --nodes=2"
 NTASKS = "#SBATCH --ntasks=32"
 WALLTIME = "#SBATCH --time=00:10:00"

[submission.task_exceptions.Prep.BATCH]
 NODES = "#SBATCH --nodes=1"
 NTASKS = "#SBATCH --ntasks=1"
 WALLTIME = "#SBATCH --time=00:10:00"

[submission.task_exceptions.marsprep.BATCH]
 NODES = "#SBATCH --nodes=1"
 NTASKS = "#SBATCH --ntasks=1"
 WALLTIME = "#SBATCH --time=01:00:00"

[troika]
config_file = "@DEODE_HOME@/deode/data/config_files/troika.yml"
