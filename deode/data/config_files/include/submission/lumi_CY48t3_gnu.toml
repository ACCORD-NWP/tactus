account = "#SBATCH -A project_465000527"
bindir = "/scratch/project_465000527/jasinskas/CY48T3-gfortran12-O2_24-install/bin"
cmicro = "OLD3"
default_submit_type = "serial"
lfftw = true
max_ecf_tasks = 2
module_initpath = "/usr/share/lmod/8.3.1/init"
nproma = -64
submit_types = ["background_vm", "background_hpc", "serial", "parallel", "sqlite"]

[background_hpc]
  SCHOST = "localhost"
  tasks = ["Background_hpc", "UnitTest"]
  wrapper = "time"

[background_vm]
  INTERPRETER = "#!/usr/bin/python3"
  SCHOST = "localhost"
  tasks = ["Background_vm"]

[parallel]
  NPROC = 16
  SCHOST = "lumi-batch"
  tasks = ["Forecast", "E927", "Pgd", "Prep", "C903", "E923Monthly", "E923Constant"]
  WRAPPER = "srun -n @NPROC@"

[parallel.BATCH]
  NAME = "#SBATCH --job-name=@TASK_NAME@"
  NODES = "#SBATCH --nodes=1"
  NTASKS = "#SBATCH --ntasks=1"
  PARTITION = "#SBATCH -p debug"
  WALLTIME = "#SBATCH --time=00:10:00"

  # EXPORT_NONE = "#SBATCH --export=NONE"

[parallel.ENV]
  ECF_SSL = 1
  # Nodes, MPI tasks etc
  MPI_TASKS = 32 # $SLURM_NTASKS
  OMP_NUM_THREADS = 1 # CPUS_PER_TASK

  # Open-MP business :
  # OMP_PLACES looks important for the binding by srun :
  KMP_MONITOR_STACKSIZE = "4G"
  KMP_STACKSIZE = "4G"
  OMP_PLACES = "threads"
  OMP_STACKSIZE = "4G"

  # DR_HOOK
  DR_HOOK = 1
  DR_HOOK_ALLOW_COREDUMP = 0
  DR_HOOK_IGNORE_SIGNALS = 8
  DR_HOOK_SHOW_PROCESS_OPTIONS = 0
  DR_HOOK_SILENT = 1

  # EC PROFILE
  EC_MEMINFO = 0
  EC_MPI_ATEXIT = 0
  EC_PROFILE_HEAP = 0
  EC_PROFILE_MEM = 0

  FI_CXI_RX_MATCH_MODE = 'hybrid'

[parallel.MODULES]
  00_PURGE = ["--force", "purge"]
  14_RIMVYDAS_USE = ["use", "/scratch/project_465000527/SW/modules/"]
  15_RIMVYDAS_FTN16 = ["load", "scl-gfortran12_23"]
  16_RIMVYDAS_ECFLOW = ["load", "scl-ecflow_23"]
  99_LIST = ["list", ""]

[serial]
  NPROC = 1
  SCHOST = "lumi-batch"
  tasks = ["Gmted", "Soil", "PgdUpdate"]
  WRAPPER = "srun"

[serial.BATCH]
  NAME = "#SBATCH --job-name=@TASK_NAME@"
  NODES = "#SBATCH --nodes=1"
  NTASKS = "#SBATCH --ntasks=1"
  PARTITION = "#SBATCH --partition=debug"
  WALLTIME = "#SBATCH --time=00:20:00"

  #EXPORT_NONE = "#SBATCH --export=NONE"

[serial.ENV]
  DR_HOOK_ALLOW_COREDUMP = 0
  DR_HOOK_IGNORE_SIGNALS = 8
  ECF_SSL = 1
  MPI_TASKS = 32
  MPITASKS_PER_NODE = 8
  NPROC = 32
  OMP_NUM_THREADS = 1
  OMPI_MCA_btl = '^vader'

[serial.MODULES]
  00_PURGE = ["--force", "purge"]
  01_USE = ["use", "/scratch/project_465000527/SW/modules/"]
  02_FTN16 = ["load", "scl-gfortran12_23"]
  03_ECFLOW = ["load", "scl-ecflow_23"]
  99_LIST = ["list", ""]

[sqlite]
  NPROC = 1
  SCHOST = "lumi-batch"
  tasks = ["ExtractSQLite"]
  WRAPPER = "time"

[sqlite.BATCH]
  EXPORT = "#SBATCH --export=NONE"
  MEM = "#SBATCH --mem=0"
  NAME = "#SBATCH --job-name=@TASK_NAME@"
  NODES = "#SBATCH --nodes=1"
  NTASKS = "#SBATCH --ntasks=1"
  PARTITION = "#SBATCH --partition=debug"
  WALLTIME = "#SBATCH --time=00:20:00"

[sqlite.ENV]
  ECF_SSL = 1

[sqlite.MODULES]
  01_USE = ["use", "/scratch/project_465000527/SW/modules/"]
  02_ECCODES = ["load", "scl-pyeccodes_23"]
  03_ECFLOW = ["load", "scl-ecflow_23"]

[task]
  wrapper = "time"

[task_exceptions.C903]
  NPROC = 12

[task_exceptions.C903.BATCH]
  MEM = "#SBATCH --mem=0"
  NODE = "#SBATCH --nodes=4"
  NTASKS = "#SBATCH --ntasks=12"
  TASKS_PER_NODE = "#SBATCH --ntasks-per-node=3"
  WALLTIME = "#SBATCH --time=00:30:00"

[task_exceptions.C903.ENV]
  DR_HOOK_TRAPFPE_DIVBYZERO = 1
  DR_HOOK_TRAPFPE_OVERFLOW = 1
  OMP_NUM_THREADS = 1

[task_exceptions.E923Constant]
  NPROC = 1

[task_exceptions.E923Monthly]
  NPROC = 1

[task_exceptions.E927]
  NPROC = 16

[task_exceptions.E927.BATCH]
  NODES = "#SBATCH --nodes=1"
  NTASKS = "#SBATCH --ntasks=16"

[task_exceptions.Forecast]
  WRAPPER = "ulimit -s unlimited; srun -n @NPROC@"

[task_exceptions.Forecast.BATCH]
  CPU = "#SBATCH --cpus-per-task=4"
  JOBNAME = "#SBATCH --job-name=Forecast"
  NODES = "#SBATCH --nodes=2"
  NTASKS = "#SBATCH --ntasks=16"
  PARTITION = "#SBATCH --partition=debug"
  TASKS_PER_NODE = "#SBATCH --ntasks-per-node=8"
  WALLTIME = "#SBATCH --time=00:30:00"

  #EXCLUSIVE= "#SBATCH --exclusive"

[task_exceptions.Forecast.ENV]
  DR_HOOK = 1
  RTTOV_COEFDIR = "/scratch/project_465000527/de_33050_common_data/DEODE/satellite/rtcoef_rttov12/harm_coef/"

[task_exceptions.Gmted.MODULES]
  GDAL = ["load", "scl-gdal_23"]

[task_exceptions.Marsprep]
  WRAPPER = ""

[task_exceptions.Marsprep.BATCH]
  MEM = "#SBATCH --mem=0GB"
  NODES = "#SBATCH --nodes=1"
  NTASKS = "#SBATCH --ntasks=1"
  WALLTIME = "#SBATCH --time=00:10:00"

[task_exceptions.Marsprep.ENV]
  MARS_READANY_BUFFER_SIZE = 17893020000

[task_exceptions.Pgd]
  WRAPPER = "srun -n 16"

[task_exceptions.Pgd.BATCH]
  NODES = "#SBATCH --nodes=1"
  NTASKS = "#SBATCH --ntasks=16"

[task_exceptions.Pgd.ENV]
  OMP_NUM_THREADS = 1

[task_exceptions.Soil.MODULES]
  GDAL = ["load", "scl-gdal_23"]
