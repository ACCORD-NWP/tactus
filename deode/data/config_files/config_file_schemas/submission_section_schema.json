{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Submission Section, defined in files under include/submission",
  "description": "Defines host dependent runtime settings such as binaries, batch job rules, modules and similar",
  "type": "object",
  "additionalProperties": true,
  "properties": {
    "account": {
      "type": "string",
      "description": "Global setting of account to be used. E.g. `#SBATCH -A some_account` for slurm. Setting of account on group or task level overrides the global setting"
    },
    "bindir": {
      "type": "string",
      "description": "Location of IAL binaries",
      "default": "@INSTALL_DIR@/@CYCLE@/@COMPILER@/R64/@IAL_VERSION@/bin"
    },
    "bindir_gl": {
      "type": "string",
      "description": "Location of GL binary",
      "default": "@INSTALL_DIR@/gl/@COMPILER@/@GL_VERSION@/bin/"
    },
    "compiler": {
      "description": "Compiler used to build IAL",
      "type": "string",
      "enum": ["intel", "gnu",""],
      "default": "intel"
    },
    "precision": {
      "description": "Floating point precision as used in the Forecast task",
      "type": "string",
      "enum": ["R32", "R64",""],
      "default": "R32"
    },
    "ial_version": {
      "description": "Version of IAL binary to use",
      "type": "string",
      "default": "latest"
    },
    "gl_version": {
      "description": "Version of GL binary to use",
      "type": "string",
      "default": "latest"
    },
    "nproma": {
      "type": "number",
      "description": "NPROMA size in the forecast model. See the namelists for where it is used",
      "default": -32
    },
    "lfftw": {
      "type": "boolean",
      "description": "Use of the FFTW library. See the namelists for where it is used",
      "default": true
    },
    "module_initfile": {
      "type": "string",
      "description": "File to use for module initialization, overrides module_initpath"
    },
    "module_initpath": {
      "type": "string",
      "description": "Path to the version of env_modules_python.py to be used in the module initialization"
    },
    "default_submit_type": {
      "type": "string",
      "description": "Defines the default submit type for tasks not listed in any defined type"
    },
    "task_exceptions": {
      "type": "object",
      "description": "Allows to define task specific settings like BATCH, MODULES, NPROC. Use as task_exceptions.taskname.property",
      "properties": {
        "Marsprep": {
          "type": "object",
          "description": "Settings specific to Marsprep tasks",
          "properties": {
            "ENV": {
              "type": "object",
              "description": "Sets environment variables",
              "properties": {
                "MARS_MULTITARGET_STRICT_FORMAT": {
                  "type": "number",
                  "description": "Strict format for multitarget operations",
                  "default": 1
                },
                "MARS_READANY_BUFFER_SIZE": {
                  "type": "number",
                  "description": "Reandomly buffer size in mars",
                  "default": 17893020000
                }
              },
              "default": {}
            }
          }
        }
      }
    },
    "types": {
      "title": "Submission types",
      "description": "Defines settings related to various groups",
      "type": "object",
      "properties": {
        "serial": {
          "$ref": "#/$submission_group"
        },
        "parallel": {
          "$ref": "#/$submission_group"
        },
        "background_vm": {
          "$ref": "#/$submission_group"
        },
        "background_hpc": {
          "$ref": "#/$submission_group"
        },
        "gnu": {
          "$ref": "#/$submission_group"
        },
        "sqlite": {
          "$ref": "#/$submission_group"
        },
        "Forecast_cpu": {
          "$ref": "#/$submission_group"
        },
        "Forecast_gpu": {
          "$ref": "#/$submission_group"
        }
      }
    },
    "iomerge": {
      "title": "IO-merge group",
      "description": "Defines settings related to the iomerge task",
      "type": "object",
      "properties": {
        "age_limit": {
          "title": "IO-merge processing wait limits",
          "description": "Time in seconds to wait before processing files.",
          "type": "object",
          "properties": {
            "forecast_directory": {
              "description": "Time to wait for the Forecast directory",
              "type": "number",
              "default": 300
            },
            "fullpos": {
              "description": "Fullpos files",
              "type": "number",
              "default": 15
            },
            "history": {
              "description": "History files",
              "type": "number",
              "default": 20
            },
            "surfex": {
              "description": "Surfex files",
              "type": "number",
              "default": 15
            }
          }
        },
        "files_expected": {
          "title": "IO-merge file expectations",
          "description": "Number of files expected for merge. Set to 0 to let the code decide and -1 for no checking.",
          "type": "object",
          "properties": {
            "history": {
              "description": "History files, 0 implies -1 as the number of files is highly output dependent.",
              "type": "number",
              "default": -1
            },
            "surfex": {
              "description": "Surfex files, 0 implies nproc_io files",
              "type": "number",
              "default": 0
            },
            "fullpos": {
              "description": "Fullpos files, 0 implies 1+nproc_io files",
              "type": "number",
              "default": 0
            }
          }
        }
      }
    }
  },
  "$submission_group": {
    "title": "Submission group",
    "description": "Defines the properties avilable for a submit group. See the existing submission files for examples",
    "type": "object",
    "properties": {
      "tasks": {
        "description": "List of tasks belonging to this group",
        "type": "array",
        "items": {
          "type": "string"
        }
      },
      "SCHOST": {
        "description": "Name of the host where the job runs",
        "type": "string",
        "minLength": 1
      },
      "NPROC": {
        "description": "Number of processors for this task",
        "type": "number"
      },
      "NPROC_IO": {
        "description": "Number of io processors for this task, only applicable for tasks involving the forecast model",
        "type": "number",
        "default": 0
      },
      "WRAPPER": {
        "description": "Prefix for binaries to be executed, e.g. srun",
        "type": "string",
        "default": ""
      },
      "BATCH": {
        "description": "Sets batch job arguments like walltime",
        "type": "object"
      },
      "ENV": {
        "description": "Sets environment variables",
        "type": "object"
      },
      "MODULES": {
        "description": "Sets modules to purge/use/unload/load or switch. To maintain the order decorate with comments to override the automatic sorting",
        "type": "object",
        "patternProperties": {
          "^(.*)$": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "minItems": 1,
            "maxItems": 3
          }
        }
      }
    },
    "required": ["SCHOST"]
  }
}
