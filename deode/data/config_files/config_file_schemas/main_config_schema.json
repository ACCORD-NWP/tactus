{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Config",
  "description": "Model for validation of `deode`'s main config file.",
  "type": "object",
  "additionalProperties": true,
  "properties": {
    "general": {
      "$ref": "#/definitions/general"
    },
    "suite_control": {
      "$ref": "#/definitions/suite_control"
    },
    "clean_old_data": {
      "$ref": "#/definitions/clean_old_data"
    },
    "system": {
      "$ref": "#/definitions/system"
    },
    "boundaries": {
      "$ref": "#/definitions/boundaries"
    },
    "collectlogs": {
      "$ref": "#/definitions/collectlogs"
    },
    "pgd": {
      "$ref": "#/definitions/pgd"
    },
    "fullpos": {
      "$ref": "#/definitions/fullpos"
    },
    "troika": {
      "$ref": "#/definitions/troika"
    },
    "include": {
      "$ref": "#/definitions/include"
    },
    "gribmodify": {
      "$ref": "#/definitions/gribmodify"
    }
  },
  "required": ["general"],
  "definitions": {
    "include": {
      "title": "Include Section",
      "description": "Sections to be included from other config files. Specified as 'key = val' pairs, where the keys are the section names and the vals are the paths to the files containing them.",
      "type": "object",
      "properties": {}
    },
    "troika": {
      "title": "Troika",
      "description": "DEODE system specific path settings",
      "type": "object",
      "properties": {
        "config_file": {
          "type": "string",
          "description": "Troika config file",
          "default": "@DEODE_HOME@/data/config_files/troika.yml"
        },
        "troika": {
          "type": "string",
          "description": "Troika command, allows to specify troika with full path",
          "default": "troika"
        }
      }
    },
    "plugin_registry": {
      "title": "Plug-in registry",
      "type": "object",
      "properties": {
        "plugins": {
          "title": "Loaded plugins",
          "type": "object"
        }
      }
    },
    "boundaries": {
      "title": "Boundary Section",
      "description": "Settings for control of boundary treatment.",
      "type": "object",
      "properties": {
        "bdint": {
          "description": "Boundary interval",
          "type": "string",
          "format": "duration"
        },
        "bdshift": {
          "description": "Shift of boundary initial time. E.g. 'PT3H' would mean use 3H old boundaries",
          "type": "string",
          "format": "duration"
        },
        "max_interpolation_tasks": {
          "description": "Number of interpolate tasks run in parallel",
          "type": "number"
        },
        "bdmodel": {
          "description": "Coupling model",
          "default": "ifs",
          "enum": ["lam", "ifs"],
          "type": "string"
        },
        "humi_gp": {
          "type": "boolean",
          "description": "Value of TFP_Q%LLGP in domain namelist for c903. True for gridpoint humidity."
        },
        "lam": {
          "title": "LAM related boundary settings",
          "description": "LAM related boundary settings",
          "type": "object",
          "properties": {
            "bdcycle_start": {
              "description": "lam boundary model cycle start hour",
              "type": "string",
              "default": "PT0H",
              "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?(T(?=\\d+[HMS])(\\d+H)?(\\d+M)?(\\d+S)?)?$"
            },
            "bdcycle": {
              "description": "lam boundary model cycle interval",
              "type": "string",
              "default": "PT24H",
              "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?(T(?=\\d+[HMS])(\\d+H)?(\\d+M)?(\\d+S)?)?$"
            }
          }
        },
        "ifs": {
          "title": "IFS related settings",
          "description": "Model for the 'general.times' section.",
          "type": "object",
          "properties": {
            "selection": {
              "type": "string",
              "description": "Selection",
              "enum": [
                "atos_bologna_DT",
                "lumi_DT",
                "ATOS_DT",
                "HRES",
                "@HOST@_DT",
                "DT12",
                "i5qp",
                "i7u4",
                "i7ye",
                "i8hy",
                "IFSENS",
                "iit7",
                "ilv7"
              ]
            },
            "bdmembers": {
              "anyOf": [
                {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                {
                  "type": "array",
                  "items": {
                    "type": "integer"
                  }
                }
              ],
              "description": "List of members in ensemble if selection is IFS.",
              "default": []
            },
            "bdmember": {
              "anyOf": [
                {
                  "type": "integer"
                },
                {
                  "type": "string"
                }
              ],
              "description": "Boundary member number a given ensemble member shall use if selection is IFS",
              "default": 0
            }
          }
        },
        "bd_has_surfex": {
          "description": "Set to true if the host model runs with surfex",
          "type": "boolean"
        }
      }
    },
    "collectlogs": {
      "title": "CollectLogs Section",
      "description": "Settings for control of log collection.",
      "type": "object",
      "properties": {
	"staticlogs": {
          "description": "Collection settings for static tasks",
          "type": "object",
          "properties": {
            "joboutdir": {
              "description": "Top output dir to collect logs from ",
              "type": "string"
            },
            "tarname": {
              "description": "Name of the resulting tar file",
              "type": "string"
            },
            "task_logs": {
              "description": "Search path for task specific logs",
              "type": "string"
            }
          }
        },
	"hourlogs": {
          "description": "Collection settings for time dependent tasks",
          "type": "object",
          "properties": {
            "joboutdir": {
              "description": "Top output dir to collect logs from ",
              "type": "string"
            },
            "tarname": {
              "description": "Name of the resulting tar file",
              "type": "string"
            },
            "task_logs": {
              "description": "Search path for task specific logs",
              "type": "string"
            }
          }
        }
      }
    },
    "clean_old_data": {
      "title": "Cleaning old data",
      "decription": "Option for cleaning old data",
      "type": "object",
      "properties": {
        "ehype_data_period": {
          "description": "Age for old ehype data in days",
          "type": "string",
          "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?$",
          "default": "P14D"
        },
        "scratch_data_period": {
          "description": "Age for old data in days",
          "type": "string",
          "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?$",
          "default": "P14D"
        },
        "suites_period": {
          "description": "Age for old data in days",
          "type": "string",
          "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?$",
          "default": "P14D"
        },
        "IFS_period": {
          "description": "Age for old data in days",
          "type": "string",
          "pattern": "^P(?!$)(\\d+Y)?(\\d+M)?(\\d+W)?(\\d+D)?$",
          "default": "P7D"
        },
        "ignore": {
          "decription": "File not to remove",
          "type": "array",
          "default": []
        },
        "suite_format": {
          "decription": "Format of path to ecf files",
          "type": "string",
          "default": "/"
        },
        "scratch_format": {
          "decription": "Format of path to scratch",
          "type": "string",
          "default": "/"
        },
        "ifs_format": {
          "decription": "Format of path to IFS",
          "type": "string",
          "default": "/IFS/(\\d{4})/(0[1-9]|1[0-2])/(0[1-9]|[12]\\d|3[01])/([01]\\d|2[0-3])"
        },
        "scratch_ext": {
          "decription": "Extention of cratche for operational user.",
          "type": "string",
          "default": "deode"
        }
      }
    },
    "pgd": {
      "title": "Pgd Section",
      "description": "Settings for control of Pgd selection.",
      "type": "object",
      "properties": {
        "npatch": {
          "title": "Number of patches for surfex variables",
          "type": "integer",
          "default": 3
        },
        "one_decade": {
          "title": "Option for using one decade",
          "type": "boolean",
          "default": true
        },
        "use_osm": {
          "title": "Option to use Open Street map input data",
          "type": "boolean",
          "default": false
        }
      }
    },
    "fullpos": {
      "title": "Fullpos Section",
      "description": "Settings for control of fullpos selection.",
      "type": "object",
      "properties": {
        "config_path": {
          "title": "Path to fullpos config files",
          "type": "string",
          "default": "@DEODE_HOME@/data/namelist_generation_input/@CYCLE@/fullpos"
        },
        "main": {
          "description": "List of mandatory rules",
          "type": "array",
          "items": {
            "type": "string"
          },
          "default": ["rules", "namfpc_header"]
        },
        "selection": {
          "description": "List of selections to include",
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "domain_name": {
          "type": "string",
          "description": "Name of your domain as used by fullpos",
          "maxLength": 20,
          "default": "DOMAIN"
        }
      }
    },
    "suite_control": {
      "title": "Suite control",
      "description": "Suite control options",
      "type": "object",
      "properties": {
        "suite_definition": {
          "description": "Suite definition to play in EcFlow",
          "type": "string",
          "default": "DeodeSuiteDefinition"
        },
        "do_creategrib_static": {
          "description": "Activate grib conversion for static files",
          "type": "boolean",
          "default": false
        },
        "do_soil": {
          "description": "Activate preparation of SOILGRID data as input for PGD",
          "type": "boolean"
        },
        "do_pgd": {
          "description": "Activate generation of a PGD file",
          "type": "boolean"
        },
        "mode": {
          "description": "Choose a strategy to achieve initial/initial_sfx files (start:  start from interpolated files and then propagate the FG between cycles, restart: start from a previous run and then propagate the FG between cycles, cold_start: always start from interpolated files).",
          "type": "string",
          "enum": ["start", "restart", "cold_start"]
        },
        "interpolate_boundaries": {
          "description": "Activates the boundary interpolation",
          "type": "boolean"
        },
        "do_marsprep": {
          "description": "Run marsprep or skip extraction",
          "type": "boolean"
        },
        "do_extractsqlite": {
          "description": "Activates extraction of selected points to SQLite files for verification.",
          "type": "boolean"
        },
        "create_static_data": {
          "description": "Activate the generation of PGD and monthly climate files in the suite",
          "type": "boolean"
        },
        "create_time_dependent_suite": {
          "description": "Activate the time dependent part of the suite",
          "type": "boolean"
        },
        "split_mars": {
          "description": "Do marsprep only for one step before c903",
          "type": "boolean",
          "default": false
        },
        "do_cleaning": {
          "description": "Do file cleaning",
          "type": "boolean",
          "default": false
        },
        "n_io_merge": {
          "description": "Number of IOmerge tasks",
          "type": "integer",
          "default": 1
        },
        "n_creategrib": {
          "description": "Number of CreateGrib tasks",
          "type": "integer",
          "default": 1
        },
        "n_addcalculatedfields": {
          "description": "Number of AddCalculatedFields tasks",
          "type": "integer",
          "default": 1
        },
        "member_specific_static_data": {
          "description": "Whether to create member specific static data (true) or not",
          "type": "boolean",
          "default": false
        },
        "member_specific_mars_prep": {
          "description": "Whether to do member specific marsprep (true) or common marsprep",
          "type": "boolean",
          "default": false
        },
        "max_static_data_tasks": {
          "description": "Limit for max number of monthly tasks, run at same time",
          "type": "integer",
          "default": 10
        },
        "DeodeCleaningSuiteDefinition": {
          "decription": "Settings for Cleaning Suite",
          "type": "object",
          "properties": {
            "do_clean_scratch_data": {
              "description": "Activate cleaning the scratch data",
              "type": "boolean",
              "default": true
            },
            "do_clean_suites": {
              "description": "Activate cleaning the suites",
              "type": "boolean",
              "default": true
            },
            "do_clean_IFS": {
              "description": "Activate cleaning IFS data",
              "type": "boolean",
              "default": true
            },
            "days_in_week": {
              "description": "List of days when cleaning suite will run, 0-6 Sunday-Saturday",
              "type": "array",
              "items": {
                "type": "integer"
              }
            },
            "time_to_run": {
              "description": "Time to run",
              "type": "string",
              "pattern": "^([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\dZ$"
            }
          }
        }
      }
    },
    "system": {
      "title": "System",
      "description": "DEODE system specific path settings",
      "type": "object",
      "properties": {
        "forecast_dir_link": {
          "type": "string",
          "description": "Name of the softlink pointing to the Forecast task work directory",
          "default": "../Forecast"
        },
        "bdfile_sfx_template": {
          "type": "string",
          "description": "Name template for input initial surfex file for prep"
        },
        "bdfile_template": {
          "type": "string",
          "description": "Name template for input boundary files"
        },
        "bddir_sfx": {
          "type": "string",
          "description": "Location of input intial file for surfex"
        },
        "bddir": {
          "type": "string",
          "description": "Location of input boundaries"
        },
        "intp_bddir": {
          "type": "string",
          "description": "Location of boundaries on the current domain, i.e. the output directory of e927",
          "default": "@WRK@"
        },
        "climdir": {
          "type": "string",
          "description": "Location of generated/used climate files (PGD/monthly files)"
        },
        "bindir": {
          "type": "string",
          "description": "Location of binaries"
        },
        "bdclimdir": {
          "type": "string",
          "description": "Location of host model climate files used for e927/c903"
        },
        "wrk": {
          "type": "string",
          "description": "Location of date specific working directory",
          "default": "@CASEDIR@/@YYYY@@MM@@DD@_@HH@@mm@"
        },
        "fullpos_config_file": {
          "type": "string",
          "description": "Path to the fullpos yml config file"
        },
        "archive_timestamp": {
          "type": "string",
          "description": "Relative path of date specific archive",
          "default": "@YYYY@/@MM@/@DD@/@HH@/"
        },
        "archive": {
          "type": "string",
          "description": "Absolute path of date specific archive",
          "default": "@ARCHIVE_ROOT@/@ARCHIVE_TIMESTAMP@/@MEMBER_STR@"
        },
        "logs": {
          "type": "string",
          "description": "Location of collected logfiles"
        },
        "namelists": {
          "type": "string",
          "description": "Path to static namelists",
          "default": "@DEODE_HOME@/data/namelists/@CYCLE@"
        },
        "marsdir": {
          "type": "string",
          "description": "Location input files extracted from MARS by Marsprep"
        },
        "global_sfcdir": {
          "type": "string",
          "description": "Path to SFC files needed for c903, which are not in MARS"
        },
        "prev_case": {
          "description": "Name of the previous experiment",
          "type": "string",
          "default": "@CASE@"
        },
        "sfx_input_definition": {
          "description": "Path to the surfex json config file",
          "type": "string",
          "default": "@CYCLE@/sfx.json"
        },
        "forecast_input_definition": {
          "type": "string",
          "description": "Path to the forecast json config file",
          "default": "@CYCLE@/forecast.json"
        },
        "c903_input_definition": {
          "type": "string",
          "description": "Path to the c903 json config file",
          "default": "@CYCLE@/c903.json"
        }
      }
    },
    "gribmodify": {
      "title": "Section for modify grib",
      "description": "Rules for modifications to be made to the grib output",
      "type": "object",
      "properties": {
        "conversions": {
          "description": "List of file types to be converted",
          "type": "array",
          "default": []
        },
        "gribmodify_rules_file": {
          "description": "File specifying the gribmodify rules for the specified conversions",
          "type": "string"
        },
        "fullpos.1": {
          "title": "Total rain",
          "description": "Calculates total rain from components",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "fullpos.2": {
          "title": "Total snow",
          "description": "Calculates total snow from components",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "fullpos.3": {
          "title": "Total precpipation",
          "description": "Calculates total precipitation from components",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "fullpos.4": {
          "title": "10m wind speed",
          "description": "Calculates 10m wind speed",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "fullpos.5": {
          "title": "100m wind speed",
          "description": "Calculates 100m wind speed",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "fullpos.6": {
          "title": "10m gust wind speed",
          "description": "Calculates 10m gust wind speed",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "surfex.1": {
          "title": "Leaf area index",
          "description": "Calculates nature-weighted leaf area index",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "surfex.2": {
          "title": "Albedo",
          "description": "Calculates albedo",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "surfex.3": {
          "title": "Top 20 cm average soil moisture",
          "description": "Calculates the nature-weighted patch-averaged soil moisture in the top 20 cm",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "surfex.4": {
          "title": "Top 100 cm average soil moisture",
          "description": "Calculates the nature-weighted patch-averaged soil moisture in the top 100 cm",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "surfex.5": {
          "title": "Top 20 cm average soil temperature",
          "description": "Calculates the patch-averaged soil temperature in the top 20 cm",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "surfex.6": {
          "title": "Top 100 cm soil temperature",
          "description": "Calculates the patch-averaged soil temperature in the top 100 cm",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "surfex.7": {
          "title": "Root depth soil moisture",
          "description": "Calculates root depth soil moisture",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        },
        "surfex.8": {
          "title": "Canopy water",
          "description": "Calculates the patch-averaged canopy water",
          "type": "object",
          "properties": {
            "$ref": "#/$gribmodify_rules"
          }
        }
      }
    },
    "general": {
      "title": "General Section",
      "description": "Model for the 'general' section.",
      "type": "object",
      "properties": {
        "times": {
          "title": "Time-Related Entries",
          "description": "Model for the 'general.times' section.",
          "type": "object",
          "properties": {
            "forecast_range": {
              "description": "Forecast range",
              "type": "string",
              "format": "duration"
            },
            "start": {
              "description": "Start",
              "type": "string",
              "format": "date-time"
            },
            "end": {
              "description": "End",
              "type": "string",
              "format": "date-time"
            },
            "list": {
              "description": "List",
              "type": "array",
              "items": {
                "type": "string",
                "format": "date-time"
              }
            },
            "cycle_length": {
              "description": "Cycle length defined as duration",
              "default": "PT3H",
              "type": "string",
              "format": "duration"
            },
            "basetime": {
              "description": "Initial date and time for the current task.",
              "type": "string",
              "format": "date-time"
            },
            "validtime": {
              "description": "Final date and time for the current task.",
              "type": "string",
              "format": "date-time"
            }
          },
          "oneOf": [
            {
              "anyOf": [
                {
                  "required": ["start"],
                  "not": {
                    "required": ["list"]
                  }
                },
                {
                  "required": ["basetime"],
                  "not": {
                    "anyOf": [
                      {
                        "required": ["end"]
                      },
                      {
                        "required": ["list"]
                      },
                      {
                        "required": ["start"]
                      }
                    ]
                  }
                }
              ]
            },
            {
              "required": ["list"],
              "not": {
                "anyOf": [
                  {
                    "required": ["start"]
                  },
                  {
                    "required": ["end"]
                  }
                ]
              }
            }
          ]
        },
        "accept_static_namelists": {
          "description": "Allow usage of static namelists as input for the tasks. The namelist should be located in the directory specified by platform.namelists and named with the convention namelist_{kind}_{task} where kind could be surfex or master and task forecast/pgd or similar. For the extraction of namelist see [namelists.md](../docs/namelists.md).",
          "type": "boolean"
        },
        "case": {
          "description": "Experiment name",
          "default": "deode_case",
          "type": "string"
        },
        "member_str": {
          "description": "String identifier of a member in the ensemble",
          "default": "mbr000",
          "type": "string",
          "pattern": "^mbr\\d{3}$"
        },
        "member": {
          "description": "Member number of a member in the ensemble",
          "default": 0,
          "type": "integer"
        },
        "cnmexp": {
          "description": "Experiment short name",
          "default": "DEOD",
          "type": "string",
          "minLength": 4,
          "maxLength": 4
        },
        "loglevel": {
          "description": "Logger output level",
          "type": "string",
          "enum": ["CRITICAL", "ERROR", "DEBUG", "INFO", "WARNING"]
        },
        "surfex": {
          "description": "SURFEX switch",
          "type": "boolean"
        },
        "keep_workdirs": {
          "description": "Do not remove working directories",
          "type": "boolean"
        },
        "csc": {
          "description": "CSC",
          "default": "AROME",
          "type": "string",
          "enum": ["AROME", "ALARO", "HARMONIE_AROME"]
        },
        "cycle": {
          "description": "IAL cycle",
          "type": "string",
          "enum": ["CY49t2", "CY48t3", "CY46h1"]
        },
        "event_type": {
          "description": "Type of extreme event",
          "type": "string",
          "default": "nwp",
          "enum": [
            "airquality",
            "convection",
            "flooding",
            "heatwave",
            "nwp",
            "storm"
          ]
        },
        "initfile": {
          "description": "Initial file for the forecast object. Normally no need to provide unless there are special requirements or the forecast object is used in stand alone mode.",
          "type": "string"
        },
        "initfile_sfx": {
          "description": "Initial surfex file for the forecast object. Normally no need to provide unless there are special requirements or the forecast object is used in stand alone mode.",
          "type": "string"
        },
        "namelist": {
          "title": "Namelist",
          "description": "Namelist settings. Various settings for the forecast namelist that have no other place to go.",
          "type": "object",
          "properties": {
            "nrazts": {
              "description": "Reset times for instantaneous fluxes ( e.g. min/max temperature )",
              "type": "string"
            },
            "radiation_frequency": {
              "description": "Time interval for radiation compitations in the model.",
              "type": "string"
            }
          }
        },
        "output_settings": {
          "title": "Output Settings",
          "description": "Output settings. Specified as duration for any of interval, endtime:interval, starttime:endtime:interval or a list of these options",
          "type": "object",
          "properties": {
            "history": {
              "description": "Output list for history files",
              "$ref": "#/$output_setting_rules"
            },
            "surfex": {
              "description": "Output list for surfex files",
              "$ref": "#/$output_setting_rules"
            },
            "fullpos": {
              "description": "Output list for fullpos files",
              "$ref": "#/$output_setting_rules"
            }
          }
        },
        "remove_sections": {
          "description": "Sections to remove prior to config merge",
          "type": "array",
          "default": []
        },
        "windfarm": {
          "description": "Switch on wind farm parameterisation",
          "type": "boolean",
          "default": false
        }
      },
      "required": ["times"]
    }
  },
  "$output_setting_rules": {
    "anyOf": [
      {
        "type": "string",
        "maxLength": 0
      },
      {
        "type": "string",
        "format": "duration"
      },
      {
        "type": "array",
        "items": {
          "anyOf": [
            {
              "type": "string",
              "format": "duration_slice"
            }
          ]
        }
      }
    ]
  },
  "$gribmodify_rules": {
    "csc_specific": {
      "title": "CSC specific selection",
      "description": "The CSCs for which the specified conversion should happen.",
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "output_name": {
      "title": "Output parameter name",
      "description": "Chosen name of output parameter.",
      "type": "string"
    },
    "minumum_frequency": {
      "title": "Minimum frequency",
      "description": "Minimum output frequency expected",
      "format": "duration"
    }
  }
}
