[general]
 case = "deode_case"
 cnmexp = "DEOD"
 realization = -1
 tstep = 75
 loglevel = "info"
 csc = "HARMONIE-AROME"
 cycle = "CY46h1"
 surfex = true
 bdint = "PT3H"
 bdcycle = "PT12H"
 bdmax = 12
 forecast_range = "PT12H"
 output_interval_his = ["PT1H:PT3H:PT1H", "PT3H:PT6H:PT3H", "PT24H:PT6H"]
 output_interval_fp = "PT24H:PT15M"
 output_interval_sfx = ["PT3H:PT1H", "PT9H:PT24H:PT3H"]
 output_interval_sfx_sel = "PT1H"
 keep_workdirs = true
 create_static_data = true
 accept_static_namelists = false
 nproma = -32

[macros]
 os_macros = ["USER", "HOME", "PWD"]
 group_macros = ["platform","system"]
 gen_macros = ["general.cnmexp",
               "general.cycle",
               { exp_case = "general.case" },
               { domain = "domain.name" },
               { rrr = "general.realization" } ]

[vertical_levels]
nlev = 65
ahalf = [0.00000000,
2000.00000000,
4000.21287319,
6002.09662113,
7911.25838577,
9633.01049417,
11169.37146237,
12522.57753978,
13695.00149653,
14689.11546998,
15507.49052823,
16154.69697732,
16632.12471208,
16940.14949960,
17082.34869816,
17065.28164099,
16898.18367797,
16592.58939571,
16161.90395878,
15620.94340550,
14985.46502362,
14271.70773051,
13495.95994372,
12674.16909910,
11821.60314859,
10952.57042620,
10080.20053763,
9216.28565403,
8371.17893039,
7553.74479607,
6771.35457397,
6029.92021691,
5333.95880836,
4686.68074804,
4090.09511346,
3545.12645110,
3051.73811264,
2609.05813936,
2215.50455766,
1868.90774223,
1566.62821060,
1305.66882073,
1081.85503306,
890.47596795,
727.74548529,
590.17748096,
474.58767980,
378.08857614,
298.07947335,
232.23312781,
178.48015386,
134.99207440,
100.16369201,
72.59529482,
51.07508967,
34.56216490,
22.17022046,
13.15225964,
6.88641310,
2.86306141,
0.67344356,
0.00000000,
0.00000000,
0.00000000,
0.00000000,
0.00000000]
bhalf = [0.00000000,
0.00000000,
0.00000000,
0.00000000,
0.00095468,
0.00382570,
0.00862327,
0.01535782,
0.02404046,
0.03468314,
0.04729839,
0.06195102,
0.07868187,
0.09744325,
0.11815586,
0.14071098,
0.16497348,
0.19078554,
0.21797086,
0.24633925,
0.27569119,
0.30582244,
0.33652825,
0.36760726,
0.39886479,
0.43011564,
0.46118624,
0.49191624,
0.52215946,
0.55178443,
0.58067442,
0.60872709,
0.63585388,
0.66197911,
0.68703898,
0.71098036,
0.73375964,
0.75534143,
0.77569737,
0.79480486,
0.81264598,
0.82920633,
0.84454000,
0.85875505,
0.87191802,
0.88409276,
0.89534045,
0.90571965,
0.91528643,
0.92409452,
0.93219549,
0.93963895,
0.94647277,
0.95274328,
0.95849551,
0.96377340,
0.96862008,
0.97307803,
0.97718944,
0.98099640,
0.98454132,
0.98786727,
0.99102462,
0.99406510,
0.99703923,
1.00000000]

[domain]
 name = "DEMO_60x80_2500m"
 nimax = 49
 njmax = 69
 xloncen = 4.9
 xlatcen = 51.967
 xlon0 = 0.0
 xlat0 = 52.5
 xbeta  = 0.0
 xdx = 2500.0
 xdy = 2500.0
 ilone = 11
 ilate = 11
 nbzong = 8
 nbzonl = 8
 gridtype = "linear"

[system]
 wrk = "@SCRATCH@/deode/@CASE@/@YYYY@@MM@@DD@_@HH@@mm@"
 archive = "@ARCHIVE_ROOT@/@YYYY@/@MM@/@DD@/@HH@/"
 bddir = "/scratch/sism/DEOL/@YYYY@/@MM@/@DD@/@HH@"
 bdfile_template = "PFIFSDEOL+@LLLL@"
 bddir_sfx = "/home/snh02/work/dev-CY46h1_deode/boundaries/HRES/@YYYY@/@MM@/@DD@/@HH@"
 bdfile_sfx_template = "fc@YYYY@@MM@@DD@_@HH@+@LLL@"
 climdir = "@SCRATCH@/deode/@CASE@/climate/@DOMAIN@"
 bdclimdir = "/home/snh02/work/dev-CY46h1_deode/climate/DEODE_LARGE"
 bindir = "/home/snh02/work/dev-CY46h1_deode/bin/2023-03-29"

[platform]
 deode_home = "set-by-the-system"
 archive_root = "@SCRATCH@/deode/@CASE@/archive"
 scratch = "/scratch/@USER@"
 rrtm_dir = "@STATIC_DATA@/rrtm/46h1"
 ncdir = "/home/snh02/work/cy46t1/arome/data"
 e923_data = "@STATIC_DATA@/climate/E923_DATA"
 namelists = "@DEODE_HOME@/deode/data/namelists/CY46h1/"
 static_data = "/hpcperm/hlam/data"
 climdata = "/hpcperm/hlam/data/climate"
 ecosg_data_path = "@CLIMDATA@/ECOCLIMAP-SG"
 gmted2010_data_path = "@CLIMDATA@/GMTED2010"
 soilgrid_data_path = "@CLIMDATA@/SOILGRID"
 pgd_data_path = "@CLIMDATA@/PGD"

[general.times]
 basetime = "2023-02-19T00:00:00Z"
 validtime = "2023-02-19T00:00:00Z"
 start = "2023-02-19T00:00:00Z"
 end = "2023-02-19T03:00:00Z"
 cycle_length = "PT3H"
 
[task]
 wrapper = "srun"
[task.forecast]
 wrapper = "time srun"
[task.e923]
 wrapper = "srun"
[task.e927]
 wrapper = "srun"
[task.PgdUpdate]
 wrapper = "srun"
[task.creategrib]
 wrapper = "srun"
[task.args]
 bd_nr = "1"
 bd_time = "2023-02-19T09:00:00Z"

[task.creategrib.conversions]
  #his = { output_template = "his_basetime+duration.grib2" }
  sfx = { output_template = "sfx_basetime+duration.grib" }
  sfx_sel = { output_template = "sfx_sel_basetime+duration.grib" }

[submission]
submit_types = ["background_vm", "background_hpc", "serial", "parallel"]
default_submit_type = "serial"
[submission.background_vm]
INTERPRETER = "#!/usr/bin/python3"
SCHOST = "localhost"
tasks = ["Background_vm"]

[submission.background_hpc]
SCHOST = "localhost"
tasks = ["creategrib","Background_hpc", "UnitTest"]

[submission.serial]
 SCHOST = "hpc"
[submission.serial.BATCH]
 ACCOUNT = "#SBATCH -A msdeode"
 WALLTIME = "#SBATCH --time=00:15:00"
 QOS = "#SBATCH --qos=nf"
 NODES = "#SBATCH --nodes=1"
 NTASKS= "#SBATCH --ntasks=1"
[submission.serial.ENV]
 OS = "import os"
 MODULE_ENV = "module_env='/usr/local/apps/lmod/8.6.8/init/env_modules_python.py'"
 MODULE_INTEL= "exec(open(module_env).read()); module('load', 'prgenv/intel')"
 MODULE_MKL= "exec(open(module_env).read()); module('load', 'intel-mkl/19.0.5')"
 MODULE_OPENMPI= "exec(open(module_env).read()); module('load', 'openmpi/4.1.1.1')"
 MODULE_NETCDF4= "exec(open(module_env).read()); module('load', 'netcdf4/4.7.4')"
 MODULE_HDF5= "exec(open(module_env).read()); module('load', 'hdf5/1.10.6')"
 MODULE_ECMWF= "exec(open(module_env).read()); module('load', 'ecmwf-toolbox/2021.08.3.0')"
 MODULE_FFTW= "exec(open(module_env).read()); module('load', 'fftw/3.3.9')"
 OMP_NUM_THREADS= "os.environ['OMP_NUM_THREADS'] = '1'"
 OMPI_MCA_btl= "os.environ['OMPI_MCA_btl'] = '^vader'"

[submission.parallel]
 SCHOST = "hpc"
 tasks = ["Forecast","e927","Pgd","Prep"]
[submission.parallel.BATCH]
 ACCOUNT = "#SBATCH -A msdeode"
 WALLTIME = "#SBATCH --time=00:10:00"
 QOS = "#SBATCH --qos=np"
[submission.parallel.ENV]
 OS = "import os"
 MODULE_ENV= "exec(open('/usr/local/apps/lmod/8.6.8/init/env_modules_python.py').read())"
 MODULE_INTEL= "module('load', 'prgenv/intel')"
 MODULE_MKL= "module('load', 'intel-mkl/19.0.5')"
 MODULE_OPENMPI= "module('load', 'openmpi/4.1.1.1')"
 MODULE_NETCDF4= "module('load', 'netcdf4/4.7.4')"
 MODULE_HDF5= "module('load', 'hdf5/1.10.6')"
 MODULE_ECMWF= "module('load', 'ecmwf-toolbox/2021.08.3.0')"
 MODULE_FFTW= "module('load', 'fftw/3.3.9')"
 OMP_NUM_THREADS= "os.environ['OMP_NUM_THREADS'] = '1'"
 DR_HOOK = "os.environ['DR_HOOK'] = '1'"
 OMPI_MCA_btl= "os.environ['OMPI_MCA_btl'] = '^vader'"

[submission.task_exceptions.e927.BATCH]
 NAME = "#SBATCH --job-name=e927"
 NODES = "#SBATCH --nodes=1"
 NTASKS = "#SBATCH --ntasks=16"

[submission.task_exceptions.Forecast.BATCH]
 NAME = "#SBATCH --job-name=Forecast"
 NODES = "#SBATCH --nodes=2"
 NTASKS = "#SBATCH --ntasks=256"
 WALLTIME = "#SBATCH --time=00:30:00"

[submission.task_exceptions.Pgd.BATCH]
 NAME = "#SBATCH --job-name=Pgd"
 NODES = "#SBATCH --nodes=2"
 NTASKS = "#SBATCH --ntasks=32"
 WALLTIME = "#SBATCH --time=00:10:00"

[submission.task_exceptions.Prep.BATCH]
 NAME = "#SBATCH --job-name=Prep"
 NODES = "#SBATCH --nodes=2"
 NTASKS = "#SBATCH --ntasks=32"
 WALLTIME = "#SBATCH --time=00:10:00"

[troika]
config_file = "@DEODE_HOME@/deode/data/config_files/troika.yml"

################ Pysurfex ##############################################################
[SURFEX]
[SURFEX.IO]
CSURF_FILETYPE = "FA"
CTIMESERIES_FILETYPE = "FA"
CFORCING_FILETYPE = "NETCDF"
XTSTEP = 600
XTSTEP_OUTPUT = 21600.0
LSPLIT_PATCH = true
LSELECT = true

[SURFEX.COVER]
YCOVER = "ecosg_final_map.dir"
SG = true
H_TREE = "new_ht_c.dir"
ALBNIR_SOIL = "ALB_SAT_NI_@MM@@CDD@_c.dir"
ALBNIR_VEG = "ALB_SAT_NI_@MM@@CDD@_c.dir"
ALBVIS_SOIL = "ALB_SAT_VI_@MM@@CDD@_c.dir"
ALBVIS_VEG = "ALB_SAT_VI_@MM@@CDD@_c.dir"
LAI = "LAI_SAT_@MM@@CDD@_c.dir"

[SURFEX.ZS]
YZS = "gmted2010.dir"

[SURFEX.PARAMETERS]
XRIMAX = 0.2

[SURFEX.TILES]
SEA = "SEAFLX"
INLAND_WATER = "FLAKE"
NATURE = "ISBA"
TOWN = "TEB"

[SURFEX.SEA]
ICE = "NONE"
PERTFLUX = false
LVOLATILE_SIC = false

[SURFEX.INLAND_WATER]

[SURFEX.FLAKE]
LCLIM = true
LDB_VERSION = "3.0"

[SURFEX.ISBA]
SCHEME = "3-L"
NPATCH = 2
MEB = false
CANOPY = false
SNOW = "D95"
YSOC_TOP = "soc_top.dir"
YSOC_SUB = "soc_sub.dir"
YSAND = "SAND_SOILGRID.dir"
YCLAY = "CLAY_SOILGRID.dir"
PERTSURF = false
XCGMAX = 2e-5
XCSMAX = 0.0002

[SURFEX.SSO]
SCHEME = "NONE"

[SURFEX.TREEDRAG]
TREEDATA_FILE = ""
XSCALE_H_TREE = 1.0
XALLEN_TERM = 2.5
XGRASS_H_DNM = 3.0
FAKETREES = false

[SURFEX.TOWN]
LTOWN_TO_ROCK = false

[SURFEX.TEB]

[SURFEX.ASSIM]
CFILE_FORMAT_LSM = "ASCII"

[SURFEX.ASSIM.SCHEMES]
SEA = "NONE"
INLAND_WATER = "NONE"
ISBA = "NONE"
TEB = "NONE"

[SURFEX.ASSIM.OBS]
LOBSHEADER = false
CFILE_FORMAT_OBS = "ASCII"
LOBSNAT = false
COBS_M = [ "T2M", "HU2M", "WG2 ", "LAI", "SWE",]
NNCO = [ 1, 1, 0, 0, 1,]
XERROBS_M = [ 1.0, 0.1, 0.1, 0.1, 20.0,]
LSWE = false
NOBSTYPE_M = 2

[SURFEX.ASSIM.SEA]
CFILE_FORMAT_SST = "ASCII"
LREAD_SST_FROM_FILE = true
LEXTRAP_SEA = false
LECSST = true

[SURFEX.ASSIM.INLAND_WATER]
LWATERTG2 = false
LEXTRAP_WATER = false

[SURFEX.ASSIM.ISBA]
UPDATE_SNOW_CYCLES = []
LSWEPSINI = false
XSWEPSINI = 1000.0
LSWEPSMIN = false
XSWEPSMIN = 500.0
LPATCH1 = false

[SURFEX.ASSIM.ISBA.OI]
CFILE_FORMAT_CLIM = "ASCII"
CFILE_FORMAT_FG = "ASCII"
COEFFS = "POLYNOMES_ISBA"
XSIGT2MO = 1.0
XSIGH2MO = 0.1

[SURFEX.ASSIM.ISBA.EKF]
NNCV = [ 0, 1, 0, 1,]
XSIGMA_M = [ 2.0, 2.0, 0.1, 0.15,]
CVAR_M = [ "TG1", "TG2", "WG1", "WG2",]
XTPRT_M = [ 0.0001, 0.0001, 1e-5, 1e-5,]
XSCALE_Q = 0.125
EVOLVE_B = false
LLINCHECK = true
XALPHA = 0.2

[SURFEX.ASSIM.ISBA.ENKF]
NNCV = [ 1, 1, 1, 1, 1, 1,]
CVAR_M = [ "TG1", "TG2", "TG3", "WG2", "WG3", "WG4",]
NENS_M = 16
LPASSIVE_MODE = false
